@startuml
!theme plain
hide circle
skinparam ParticipantPadding 20
skinparam BoxPadding 10

title "CryptoFlow: Repository Pattern (Entity <-> SQL Model Mapping)"

box "Layer 2: Application (Pure Logic)" #E6FFEC
    participant "PlaceOrder\nUseCase" as UseCase
    participant "Order Entity\n(Pure Python)" as Entity
    participant "<<Interface>>\nOrderRepository" as RepoPort
end box

box "Layer 3: Infrastructure (Persistence)" #E1F5FE
    participant "SqlAlchemy\nOrderRepository" as RepoImpl
    participant "OrderModel\n(SQLAlchemy ORM)" as DBModel
    participant "AsyncSession" as Session
end box

database "PostgreSQL" as DB

' --- FLOW ---
note over UseCase: User wants to save an Order.\nUseCase holds a Domain Entity.

UseCase -> UseCase: new_order = Order(...)

UseCase -> RepoPort: add(new_order)
activate RepoPort
    ' Polymorphism
    RepoPort -> RepoImpl: add(new_order)
    activate RepoImpl

        note right of RepoImpl
            <b>THE MAPPING MAGIC</b>
            The Repository acts as a Translator.
            It converts the Domain Entity
            into a Database Model.
        end note

        RepoImpl -> Entity: Read attributes (id, symbol...)
        activate Entity
        Entity --> RepoImpl: values
        deactivate Entity

        RepoImpl -> DBModel: Create instance\n(order_id=..., symbol=...)
        activate DBModel
        DBModel --> RepoImpl: model_instance
        deactivate DBModel

        RepoImpl -> Session: add(model_instance)
        activate Session
        Session --> RepoImpl: (Pending in Transaction)
        deactivate Session

    RepoImpl --> RepoPort: void
    deactivate RepoImpl
RepoPort --> UseCase: void
deactivate RepoPort

note over UseCase: Transaction continues...\nEventually UoW calls commit().

group Unit of Work Commit
    UseCase -> Session: commit()
    activate Session
    Session -> DB: INSERT INTO orders VALUES (...)
    DB --> Session: Success
    deactivate Session
end group

@enduml